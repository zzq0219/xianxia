# 记忆系统实现指南

## 功能概述

记忆系统是一个自动捕捉和分类游戏中AI生成消息的功能模块。玩家可以通过"记忆宝鉴"查看和管理游戏历程中的各种重要事件和对话。

## 核心功能

### 1. 自动记忆捕捉
系统会在以下场景自动记录AI消息：

- **探索记忆** (`探索`): 探索过程中的故事进展和事件
- **战斗记忆** (`战斗`): 战斗结果和战斗日志
- **问诊记忆** (`问诊`): 为病人问诊的完整对话记录
- **商业记忆** (`商业`): 产业经营的每日报告和事件
- **悬赏记忆** (`悬赏`): 完成悬赏任务的追踪日志
- **培育记忆** (`培育`): 育灵轩培育成功的记录
- **交互记忆** (`交互`): 随机事件和选择结果
- **其他记忆** (`其他`): 未分类的其他重要事件

### 2. 记忆管理界面

#### 访问方式
1. 点击底部操作栏的"更多"按钮
2. 在弹出菜单中选择"记忆"按钮（粉色图标）
3. 打开"记忆宝鉴"界面

#### 界面功能
- **标签分类**: 8个分类标签，显示每个类别的记忆数量
- **章节展示**: 每条记忆作为一个章节，按时间倒序排列
- **详细信息**: 显示时间、地点、涉及角色等元信息
- **删除功能**: 悬停在记忆上时可单独删除
- **批量清空**: 可一键清空整个类别的所有记忆

### 3. 记忆数据结构

```typescript
interface MemoryEntry {
  id: string;                    // 唯一标识
  category: MemoryCategory;      // 分类
  title: string;                 // 标题
  content: string;               // 内容（AI生成的文本）
  timestamp: string;             // 游戏内时间
  realTimestamp: number;         // 真实时间戳
  location?: string;             // 发生地点
  involvedCharacters?: string[]; // 相关角色
}
```

## 实现细节

### 1. 类型定义 (`types.ts`)
- 添加了 `MemoryCategory` 类型
- 添加了 `MemoryEntry` 接口
- 添加了 `MemoryCollection` 接口
- 在 `GameState` 中添加了 `memories` 字段

### 2. 初始状态 (`constants.ts`)
```typescript
memories: {
  探索: [],
  战斗: [],
  问诊: [],
  商业: [],
  悬赏: [],
  培育: [],
  交互: [],
  其他: [],
}
```

### 3. 核心函数 (`App.tsx`)

#### `addMemory()`
```typescript
const addMemory = useCallback((
  category: MemoryCategory, 
  title: string, 
  content: string, 
  involvedCharacters?: string[]
) => {
  // 创建新记忆条目
  // 添加到对应分类
  // 限制每个分类最多100条
}, [gameState.exploration.time, gameState.exploration.location]);
```

#### `handleClearMemoryCategory()`
清空指定分类的所有记忆

#### `handleDeleteMemoryEntry()`
删除指定的单条记忆

### 4. 自动捕捉点

| 触发点 | 分类 | 捕捉时机 |
|--------|------|----------|
| `handleExplorationAction()` | 探索 | 探索行动完成后 |
| `handleCombatAction()` | 战斗 | 战斗结束时 |
| `handleEndConsultation()` | 问诊 | 结束问诊时 |
| `handleNextDay()` | 商业 | 每日结算时 |
| `handleBountyOutcome()` | 悬赏 | 完成悬赏时 |
| `handleClaimCultivation()` | 培育 | 培育完成时 |
| `handleRandomEventChoice()` | 交互 | 奇遇事件选择后 |

### 5. UI组件 (`components/MemoryModal.tsx`)

特点：
- 响应式标签栏设计
- 优雅的卡片式记忆展示
- 悬浮删除按钮
- 空状态提示
- 操作确认机制

## 使用示例

### 玩家视角
1. 进行探索、战斗等游戏活动
2. 系统自动记录重要的AI对话和事件
3. 点击"更多" → "记忆"打开记忆宝鉴
4. 切换不同标签查看各类记忆
5. 可删除不需要的记忆或清空整个分类

### 开发者扩展
如需添加新的记忆捕捉点：

```typescript
// 在适当的事件处理函数中调用
addMemory(
  '分类名称',           // MemoryCategory
  '记忆标题',           // string
  '记忆内容（AI生成）', // string
  ['相关角色1', '相关角色2'] // string[] (可选)
);
```

## 性能优化

1. **记忆数量限制**: 每个分类最多保留100条记忆
2. **懒加载**: 仅在打开记忆宝鉴时渲染内容
3. **虚拟滚动**: 适合未来添加大量记忆时使用

## 存储持久化

记忆数据保存在 `GameState.memories` 中，会随游戏存档一起保存和加载：
- 使用本地存储服务 (`storageService`)
- 支持导出/导入功能
- 与其他游戏状态同步

## 未来扩展建议

1. **搜索功能**: 在记忆中搜索关键词
2. **筛选功能**: 按角色、地点、时间筛选
3. **标签系统**: 为记忆添加自定义标签
4. **分享功能**: 将记忆导出为文本或图片
5. **重播功能**: 基于记忆重新体验某个事件
6. **成就系统**: 特定记忆解锁成就

## 技术栈

- React Hooks (useState, useCallback)
- TypeScript 类型系统
- TailwindCSS 样式
- Font Awesome 图标

## 测试建议

1. 进行一次完整的探索行动 → 检查"探索"分类
2. 进行一场战斗 → 检查"战斗"分类
3. 为病人问诊 → 检查"问诊"分类
4. 触发下一天 → 检查"商业"分类
5. 完成悬赏任务 → 检查"悬赏"分类
6. 育灵轩培育成功 → 检查"培育"分类
7. 遭遇随机事件 → 检查"交互"分类

每次操作后打开记忆宝鉴，确认记忆已正确记录并显示。

## 总结

记忆系统成功实现了以下目标：
✅ 自动捕捉各个界面生成的AI消息
✅ 按不同界面分成不同的标签栏
✅ 每一条消息作为一个章节展示
✅ 提供完善的查看和管理功能
✅ 与游戏系统完美集成

记忆系统为玩家提供了回顾游戏历程的完整功能，让游戏体验更加沉浸和有意义。