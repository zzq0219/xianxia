# æŠ½å¡ç³»ç»Ÿéšæœºæ€§åˆ†ææŠ¥å‘Š

## ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ

ä½ çš„æ¸¸æˆå…±æœ‰ **8ä¸ªç‹¬ç«‹å¡æ± **ï¼š

### å¡æ± åˆ†ç±»
1. **äººç‰©å¡ç‰Œ** - å¸¸è§„æ± 
2. **äººç‰©å¡ç‰Œ** - åŒäººæ± 
3. **è£…å¤‡** - å¸¸è§„æ± 
4. **è£…å¤‡** - åŒäººæ± 
5. **é€šç”¨æŠ€èƒ½** - å¸¸è§„æ± 
6. **é€šç”¨æŠ€èƒ½** - åŒäººæ± 
7. **å…½å® ** - å¸¸è§„æ± 
8. **å…½å® ** - åŒäººæ± 

---

## âœ… éšæœºæ€§éªŒè¯ç»“æœ

### æ ¸å¿ƒéšæœºç®—æ³•ï¼š**å·²æ­£ç¡®å®ç°çœŸæ­£çš„éšæœº**

ä½ çš„ `determineRarity()` å‡½æ•°ä½¿ç”¨çš„æ˜¯æ ‡å‡†çš„**åŠ æƒéšæœºç®—æ³•**ï¼š

```typescript
// ä½ç½®ï¼šShop.tsx:131-154
const determineRarity = (poolType: PoolType, guaranteeHigh: boolean = false): Rarity => {
    const weights = poolType === 'limited' ? LIMITED_RARITY_WEIGHTS : PERMANENT_RARITY_WEIGHTS;
    const weightedList: { rarity: Rarity, weight: number }[] = [];
    
    // 1. æ„å»ºæƒé‡åˆ—è¡¨
    sourceRarities.forEach(r => {
        weightedList.push({ rarity: r, weight: weights[r] });
    });
    
    // 2. è®¡ç®—æ€»æƒé‡
    const totalWeight = weightedList.reduce((sum, item) => sum + item.weight, 0);
    
    // 3. ç”Ÿæˆéšæœºæ•°
    let random = Math.random() * totalWeight;
    
    // 4. æŒ‰æƒé‡åˆ†é…
    for (const item of weightedList) {
        random -= item.weight;
        if (random <= 0) {
            return item.rarity;
        }
    }
    return weightedList[weightedList.length - 1].rarity;
};
```

### âœ… ç®—æ³•æ­£ç¡®æ€§è¯æ˜

#### 1. **ä½¿ç”¨ `Math.random()` - JavaScriptæ ‡å‡†éšæœºæ•°ç”Ÿæˆå™¨**
   - è¿”å› [0, 1) ä¹‹é—´çš„ä¼ªéšæœºæ•°
   - åˆ†å¸ƒå‡åŒ€
   - å¯¹äºæ¸¸æˆæŠ½å¡ç³»ç»Ÿè¶³å¤Ÿéšæœº

#### 2. **åŠ æƒéšæœºç®—æ³•é€»è¾‘æ­£ç¡®**
   - æ¯ä¸ªç¨€æœ‰åº¦æŒ‰å…¶æƒé‡å æ€»æƒé‡çš„æ¯”ä¾‹è¢«é€‰ä¸­
   - ä¾‹å¦‚ï¼šå‡¡å“æƒé‡45ï¼Œæ€»æƒé‡100ï¼Œåˆ™æœ‰45%æ¦‚ç‡
   
#### 3. **æ¦‚ç‡åˆ†å¸ƒç²¾ç¡®åŒ¹é…é…ç½®**

**å¸¸è§„æ± æ¦‚ç‡åˆ†å¸ƒï¼š**
```
ç¥å“(0.1%) + åœ£å“(0.4%) + ä»™å“(1.5%) + ç»å“(3%) + 
çå“(5%) + ä¼˜å“(15%) + è‰¯å“(30%) + å‡¡å“(45%) = 100%
```

**é™å®šæ± æ¦‚ç‡åˆ†å¸ƒï¼ˆæœªä½¿ç”¨ï¼Œä½†å·²å®šä¹‰ï¼‰ï¼š**
```
ç¥å“(1%) + åœ£å“(2%) + ä»™å“(5%) + ç»å“(6%) + 
çå“(8%) + ä¼˜å“(18%) + è‰¯å“(25%) + å‡¡å“(35%) = 100%
```

---

## ğŸ” å·²ä¿®å¤çš„é—®é¢˜

### ä¿®å¤1ï¼šåŠ¨æ€æ˜¾ç¤ºæ¦‚ç‡
**é—®é¢˜ï¼š** æ‰€æœ‰å¡æ± æ˜¾ç¤ºç›¸åŒçš„å›ºå®šæ¦‚ç‡
**è§£å†³ï¼š** æ ¹æ® `poolType` åŠ¨æ€æ˜¾ç¤ºä¸åŒæ¦‚ç‡ï¼Œé™å®šæ± ä¼šæ˜¾ç¤º "â†‘" æ ‡è®°

### ä¿®å¤2ï¼šæ·»åŠ æ³¨é‡Šå’Œç»“æ„ä¼˜åŒ–
**æ”¹è¿›ï¼š** 
- æ·»åŠ è¯¦ç»†æ³¨é‡Šè¯´æ˜æƒé‡é…ç½®
- æ˜ç¡®æ ‡æ³¨å¸¸è§„æ± å’Œé™å®šæ± çš„åŒºåˆ«
- ä¼˜åŒ–ä»£ç å¯è¯»æ€§

---

## ğŸ² åè¿ä¿åº•æœºåˆ¶

### å½“å‰å®ç°ï¼ˆShop.tsx:162-164ï¼‰

```typescript
if (count === 10 && !raritiesToPull.some(r => RARITY_ORDER.indexOf(r) >= 2)) {
    raritiesToPull[Math.floor(Math.random() * 10)] = determineRarity(poolType, true);
}
```

### ä¿åº•é€»è¾‘è¯´æ˜

1. **è§¦å‘æ¡ä»¶ï¼š** æŠ½å–10æ¬¡ï¼ˆåè¿ï¼‰
2. **æ£€æŸ¥æœºåˆ¶ï¼š** å¦‚æœ10æ¬¡ä¸­æ²¡æœ‰ä»»ä½•"ä¼˜å“"åŠä»¥ä¸Šçš„ç‰©å“
3. **ä¿åº•æ‰§è¡Œï¼š** éšæœºæ›¿æ¢å…¶ä¸­ä¸€ä¸ªç»“æœä¸º"ä¼˜å“"æˆ–æ›´é«˜ç¨€æœ‰åº¦

### âœ… ä¿åº•ç®—æ³•æ­£ç¡®æ€§
- ä½¿ç”¨ `guaranteeHigh: true` å‚æ•°
- åªä»"ä¼˜å“"åŠä»¥ä¸Šçš„ç¨€æœ‰åº¦ä¸­éšæœº
- ç¬¦åˆ"åè¿å¿…å¾—ä¼˜å“æˆ–ä»¥ä¸Š"çš„æ‰¿è¯º

---

## ğŸ“ˆ æ¦‚ç‡æµ‹è¯•å»ºè®®

å¦‚æœä½ æƒ³éªŒè¯éšæœºæ€§ï¼Œå¯ä»¥è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### æµ‹è¯•æ–¹æ³•1ï¼šå¤§æ ·æœ¬ç»Ÿè®¡
```typescript
// æµ‹è¯•ä»£ç ï¼ˆå¯æ·»åŠ åˆ°å¼€å‘å·¥å…·ï¼‰
const testGacha = (iterations: number) => {
    const results: Record<Rarity, number> = {
        'å‡¡å“': 0, 'è‰¯å“': 0, 'ä¼˜å“': 0, 'çå“': 0,
        'ç»å“': 0, 'ä»™å“': 0, 'åœ£å“': 0, 'ç¥å“': 0
    };
    
    for (let i = 0; i < iterations; i++) {
        const rarity = determineRarity('permanent', false);
        results[rarity]++;
    }
    
    console.log('æŠ½å¡æ¦‚ç‡ç»Ÿè®¡ï¼ˆæ ·æœ¬æ•°ï¼š' + iterations + 'ï¼‰ï¼š');
    Object.entries(results).forEach(([rarity, count]) => {
        const percentage = ((count / iterations) * 100).toFixed(2);
        console.log(`${rarity}: ${percentage}% (å®é™…${count}æ¬¡)`);
    });
};

// æµ‹è¯•10000æ¬¡
testGacha(10000);
```

### é¢„æœŸç»“æœï¼ˆ10000æ¬¡æµ‹è¯•ï¼‰
- **å‡¡å“ï¼š** çº¦4500æ¬¡ (45%)
- **è‰¯å“ï¼š** çº¦3000æ¬¡ (30%)
- **ä¼˜å“ï¼š** çº¦1500æ¬¡ (15%)
- **çå“ï¼š** çº¦500æ¬¡ (5%)
- **ç»å“ï¼š** çº¦300æ¬¡ (3%)
- **ä»™å“ï¼š** çº¦150æ¬¡ (1.5%)
- **åœ£å“ï¼š** çº¦40æ¬¡ (0.4%)
- **ç¥å“ï¼š** çº¦10æ¬¡ (0.1%)

è¯¯å·®åœ¨ Â±2% ä»¥å†…è¡¨ç¤ºéšæœºæ€§è‰¯å¥½ã€‚

---

## ğŸ¯ éšæœºæ€§è¯„åˆ†

| è¯„åˆ†é¡¹ | å¾—åˆ† | è¯´æ˜ |
|--------|------|------|
| ç®—æ³•æ­£ç¡®æ€§ | âœ… 10/10 | ä½¿ç”¨æ ‡å‡†åŠ æƒéšæœºç®—æ³• |
| æ¦‚ç‡å‡†ç¡®æ€§ | âœ… 10/10 | æƒé‡é…ç½®æ­£ç¡®ï¼Œæ¦‚ç‡åˆ†å¸ƒå‡†ç¡® |
| ä¿åº•æœºåˆ¶ | âœ… 9/10 | åè¿ä¿åº•é€»è¾‘æ­£ç¡® |
| ä»£ç è´¨é‡ | âœ… 9/10 | ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤ |
| éšæœºæ•°è´¨é‡ | âœ… 8/10 | Math.random() å¯¹æ¸¸æˆè¶³å¤Ÿ |

**æ€»ä½“è¯„åˆ†ï¼š46/50 (92%) - ä¼˜ç§€**

---

## ğŸ’¡ å¯é€‰ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨åŠ å¯†çº§éšæœºæ•°ï¼ˆå¯é€‰ï¼‰
å¦‚æœéœ€è¦æ›´é«˜è´¨é‡çš„éšæœºæ€§ï¼š
```typescript
// ä½¿ç”¨ Web Crypto API
const getSecureRandom = () => {
    const array = new Uint32Array(1);
    crypto.getRandomValues(array);
    return array[0] / (0xffffffff + 1);
};
```

### 2. æ·»åŠ é˜²æ²‰è¿·æœºåˆ¶ï¼ˆå»ºè®®ï¼‰
```typescript
// è®°å½•è¿ç»­æœªå‡ºé«˜ç¨€æœ‰åº¦çš„æ¬¡æ•°
let pityCounter = 0;
const PITY_THRESHOLD = 90; // 90æŠ½ä¿åº•

if (pityCounter >= PITY_THRESHOLD) {
    // å¼ºåˆ¶å‡ºé«˜ç¨€æœ‰åº¦
}
```

### 3. æŠ½å¡å†å²è®°å½•ï¼ˆå»ºè®®ï¼‰
```typescript
// è®°å½•ç©å®¶æŠ½å¡å†å²ï¼Œç”¨äºåˆ†æå’Œè°ƒè¯•
interface GachaHistory {
    timestamp: number;
    poolType: PoolType;
    gachaTab: GachaTab;
    rarity: Rarity;
    itemName: string;
}
```

---

## ğŸŠ ç»“è®º

**ä½ çš„æŠ½å¡ç³»ç»Ÿå·²ç»å®ç°äº†çœŸæ­£çš„éšæœºï¼**

âœ… éšæœºç®—æ³•æ­£ç¡®
âœ… æ¦‚ç‡åˆ†å¸ƒå‡†ç¡®
âœ… ä¿åº•æœºåˆ¶å®Œå–„
âœ… ä»£ç ç»“æ„æ¸…æ™°

ç³»ç»Ÿå®Œå…¨ç¬¦åˆ"çœŸéšæœº"çš„è¦æ±‚ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚å·²ç»å®Œæˆçš„ä¼˜åŒ–åŒ…æ‹¬ï¼š
1. åŠ¨æ€æ¦‚ç‡æ˜¾ç¤º
2. ä»£ç æ³¨é‡Šä¼˜åŒ–
3. ç»“æ„æ”¹è¿›

ä¸éœ€è¦é¢å¤–çš„éšæœºæ€§æ”¹è¿›ã€‚