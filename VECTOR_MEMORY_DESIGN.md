# å‘é‡åŒ–è®°å¿†ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

ä¸ºä»™ä¾ å¡ç‰ŒRPGæ¸¸æˆçš„è®°å¿†ç³»ç»Ÿæ·»åŠ å‘é‡åŒ–èƒ½åŠ›ï¼Œå®ç°å¯¹å†å²è®°å½•çš„æ·±å±‚æ¬¡è¯­ä¹‰ç†è§£å’Œæ™ºèƒ½æ£€ç´¢ã€‚é€šè¿‡å°†æ–‡æœ¬è®°å¿†è½¬æ¢ä¸ºå‘é‡embeddingsï¼Œå¯ä»¥è¿›è¡Œç›¸ä¼¼åº¦æœç´¢ã€ä¸»é¢˜èšç±»ã€æ™ºèƒ½æ¨èç­‰é«˜çº§åŠŸèƒ½ã€‚

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

1. **æ·±å±‚æ¬¡è®°å½•**ï¼šæ•è·è®°å¿†çš„è¯­ä¹‰ä¿¡æ¯ï¼Œè€Œéä»…å­˜å‚¨æ–‡æœ¬
2. **æ™ºèƒ½æ£€ç´¢**ï¼šåŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢ç›¸å…³è®°å¿†ï¼Œè€Œéå…³é”®è¯åŒ¹é…
3. **ç»†èŠ‚ä¿ç•™**ï¼šå‘é‡åŒ–ä¿ç•™æ‰€æœ‰ç»†èŠ‚ä¿¡æ¯çš„è¯­ä¹‰è¡¨ç¤º
4. **çµæ´»é…ç½®**ï¼šæ”¯æŒè‡ªå®šä¹‰å‘é‡åŒ–APIæœåŠ¡ï¼ˆURL + API Keyï¼‰

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ¸¸æˆè®°å¿†ç³»ç»Ÿ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ å®æ—¶è®°å½•    â”‚   â”‚  å°æ€»ç»“     â”‚   â”‚  å¤§æ€»ç»“     â”‚         â”‚
â”‚  â”‚ (æ–‡æœ¬)     â”‚   â”‚  (æ–‡æœ¬)    â”‚   â”‚  (æ–‡æœ¬)    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚        â”‚                â”‚                â”‚                  â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                        â†“                                     â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚        â”‚   å‘é‡åŒ–å¼•æ“ (Vectorizer)      â”‚                   â”‚
â”‚        â”‚   - APIè°ƒç”¨                   â”‚                   â”‚
â”‚        â”‚   - æ‰¹é‡å¤„ç†                  â”‚                   â”‚
â”‚        â”‚   - é”™è¯¯é‡è¯•                  â”‚                   â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                        â†“                                     â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚        â”‚   å‘é‡å­˜å‚¨ (Vector Store)      â”‚                   â”‚
â”‚        â”‚   - IndexedDB/LocalStorage    â”‚                   â”‚
â”‚        â”‚   - å‘é‡ç´¢å¼•                  â”‚                   â”‚
â”‚        â”‚   - å…ƒæ•°æ®å…³è”                â”‚                   â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                        â†“                                     â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚        â”‚   è¯­ä¹‰æœç´¢å¼•æ“                 â”‚                   â”‚
â”‚        â”‚   - ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—             â”‚                   â”‚
â”‚        â”‚   - Top-Kæ£€ç´¢                 â”‚                   â”‚
â”‚        â”‚   - æ··åˆæœç´¢                  â”‚                   â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ•°æ®ç»“æ„è®¾è®¡

### 1. å‘é‡åŒ–è®°å¿†æ¡ç›® (VectorizedMemoryEntry)

```typescript
interface VectorizedMemoryEntry {
  // åŸºç¡€ä¿¡æ¯
  id: string;                    // åŸå§‹è®°å¿†ID
  memoryType: 'realtime' | 'small-summary' | 'large-summary';
  category: MemoryCategory;
  
  // å‘é‡æ•°æ®
  embedding: number[];           // å‘é‡è¡¨ç¤º (ä¾‹å¦‚: 1536ç»´)
  embeddingModel: string;        // ä½¿ç”¨çš„æ¨¡å‹ (ä¾‹å¦‚: "text-embedding-3-small")
  embeddingDimension: number;    // å‘é‡ç»´åº¦
  
  // å…ƒæ•°æ®
  originalText: string;          // åŸå§‹æ–‡æœ¬
  title: string;                 // æ ‡é¢˜
  timestamp: string;             // æ¸¸æˆæ—¶é—´
  realTimestamp: number;         // çœŸå®æ—¶é—´æˆ³
  location?: string;             // åœ°ç‚¹
  involvedCharacters?: string[]; // ç›¸å…³è§’è‰²
  
  // å‘é‡åŒ–ä¿¡æ¯
  vectorizedAt: number;          // å‘é‡åŒ–æ—¶é—´æˆ³
  vectorizationStatus: 'pending' | 'success' | 'failed';
  errorMessage?: string;         // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
}
```

### 2. å‘é‡åŒ–é…ç½® (VectorConfig)

```typescript
interface VectorConfig {
  // APIé…ç½®
  enabled: boolean;              // æ˜¯å¦å¯ç”¨å‘é‡åŒ–
  apiUrl: string;                // APIåŸºç¡€URL
  apiKey: string;                // APIå¯†é’¥
  model: string;                 // ä½¿ç”¨çš„æ¨¡å‹åç§°
  
  // å‘é‡åŒ–ç­–ç•¥
  autoVectorize: boolean;        // è‡ªåŠ¨å‘é‡åŒ–æ–°è®°å¿†
  vectorizeOnSummary: boolean;   // æ€»ç»“æ—¶è‡ªåŠ¨å‘é‡åŒ–
  batchSize: number;             // æ‰¹é‡å¤„ç†å¤§å°
  
  // æœç´¢é…ç½®
  similarityThreshold: number;   // ç›¸ä¼¼åº¦é˜ˆå€¼ (0-1)
  maxResults: number;            // æœ€å¤§è¿”å›ç»“æœæ•°
  hybridSearch: boolean;         // æ˜¯å¦å¯ç”¨æ··åˆæœç´¢ï¼ˆå‘é‡+å…³é”®è¯ï¼‰
  
  // é«˜çº§è®¾ç½®
  retryAttempts: number;         // å¤±è´¥é‡è¯•æ¬¡æ•°
  cacheEnabled: boolean;         // å¯ç”¨å‘é‡ç¼“å­˜
  dimensionReduction?: {         // é™ç»´é…ç½®ï¼ˆå¯é€‰ï¼‰
    enabled: boolean;
    targetDimension: number;
    method: 'pca' | 'svd';
  };
}
```

### 3. å‘é‡å­˜å‚¨ç»“æ„ (VectorStore)

```typescript
interface VectorStore {
  vectors: {
    [category in MemoryCategory]: {
      realtime: VectorizedMemoryEntry[];
      smallSummary: VectorizedMemoryEntry[];
      largeSummary: VectorizedMemoryEntry[];
    }
  };
  
  // å‘é‡ç´¢å¼•ï¼ˆç”¨äºå¿«é€Ÿæ£€ç´¢ï¼‰
  index: {
    lastUpdated: number;
    totalVectors: number;
    byCategory: Record<MemoryCategory, number>;
  };
  
  // é…ç½®
  config: VectorConfig;
}
```

## ğŸ”§ æ ¸å¿ƒæœåŠ¡å®ç°

### 1. å‘é‡åŒ–æœåŠ¡ (services/vectorService.ts)

```typescript
class VectorService {
  private config: VectorConfig;
  private queue: VectorizeTask[] = [];
  private processing: boolean = false;
  
  // ç”Ÿæˆå‘é‡
  async vectorize(text: string): Promise<number[]> {
    const response = await fetch(`${this.config.apiUrl}/embeddings`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.config.apiKey}`
      },
      body: JSON.stringify({
        model: this.config.model,
        input: text
      })
    });
    
    const data = await response.json();
    return data.embedding;
  }
  
  // æ‰¹é‡å‘é‡åŒ–
  async batchVectorize(texts: string[]): Promise<number[][]> {
    // å®ç°æ‰¹é‡å¤„ç†é€»è¾‘
  }
  
  // è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
  cosineSimilarity(vecA: number[], vecB: number[]): number {
    const dotProduct = vecA.reduce((sum, a, i) => sum + a * vecB[i], 0);
    const magnitudeA = Math.sqrt(vecA.reduce((sum, a) => sum + a * a, 0));
    const magnitudeB = Math.sqrt(vecB.reduce((sum, b) => sum + b * b, 0));
    return dotProduct / (magnitudeA * magnitudeB);
  }
  
  // è¯­ä¹‰æœç´¢
  async semanticSearch(
    query: string,
    category?: MemoryCategory,
    topK: number = 10
  ): Promise<SearchResult[]> {
    // 1. å°†æŸ¥è¯¢å‘é‡åŒ–
    const queryVector = await this.vectorize(query);
    
    // 2. è·å–ç›¸å…³å‘é‡é›†åˆ
    const vectors = category 
      ? this.getVectorsByCategory(category)
      : this.getAllVectors();
    
    // 3. è®¡ç®—ç›¸ä¼¼åº¦
    const similarities = vectors.map(entry => ({
      entry,
      similarity: this.cosineSimilarity(queryVector, entry.embedding)
    }));
    
    // 4. æ’åºå¹¶è¿”å›Top-K
    return similarities
      .filter(s => s.similarity >= this.config.similarityThreshold)
      .sort((a, b) => b.similarity - a.similarity)
      .slice(0, topK);
  }
}
```

### 2. å‘é‡å­˜å‚¨æœåŠ¡ (services/vectorStorageService.ts)

```typescript
class VectorStorageService {
  private dbName = 'xianxia-vector-db';
  private storeName = 'vectors';
  
  // ä¿å­˜å‘é‡
  async saveVector(entry: VectorizedMemoryEntry): Promise<void> {
    const db = await this.getDb();
    await db.put(this.storeName, entry);
  }
  
  // æ‰¹é‡ä¿å­˜
  async batchSave(entries: VectorizedMemoryEntry[]): Promise<void> {
    const db = await this.getDb();
    const tx = db.transaction(this.storeName, 'readwrite');
    await Promise.all(entries.map(entry => tx.store.put(entry)));
    await tx.done;
  }
  
  // æŸ¥è¯¢å‘é‡
  async getVectorsByCategory(
    category: MemoryCategory
  ): Promise<VectorizedMemoryEntry[]> {
    const db = await this.getDb();
    const all = await db.getAll(this.storeName);
    return all.filter(v => v.category === category);
  }
  
  // è·å–æ‰€æœ‰å‘é‡
  async getAllVectors(): Promise<VectorizedMemoryEntry[]> {
    const db = await this.getDb();
    return await db.getAll(this.storeName);
  }
}
```

## ğŸ¨ UIç»„ä»¶è®¾è®¡

### 1. å‘é‡åŒ–è®¾ç½®é¢æ¿ (VectorSettingsModal)

```typescript
// åŠŸèƒ½ï¼š
// - APIé…ç½®ï¼ˆURLã€Keyã€æ¨¡å‹é€‰æ‹©ï¼‰
// - å‘é‡åŒ–ç­–ç•¥è®¾ç½®
// - æœç´¢å‚æ•°é…ç½®
// - è¿æ¥æµ‹è¯•
// - å‘é‡ç»Ÿè®¡å±•ç¤º
```

### 2. è¯­ä¹‰æœç´¢ç•Œé¢

```typescript
// åŠŸèƒ½ï¼š
// - æœç´¢è¾“å…¥æ¡†
// - åˆ†ç±»ç­›é€‰
// - ç›¸ä¼¼åº¦æ»‘å—
// - æœç´¢ç»“æœåˆ—è¡¨ï¼ˆæ˜¾ç¤ºç›¸ä¼¼åº¦åˆ†æ•°ï¼‰
// - ç»“æœé«˜äº®æ˜¾ç¤º
// - è·³è½¬åˆ°åŸå§‹è®°å¿†
```

### 3. å‘é‡åŒ–çŠ¶æ€æŒ‡ç¤ºå™¨

```typescript
// åŠŸèƒ½ï¼š
// - æ˜¾ç¤ºå‘é‡åŒ–è¿›åº¦
// - æ˜¾ç¤ºå¾…å¤„ç†é˜Ÿåˆ—
// - æ˜¾ç¤ºå¤±è´¥é¡¹
// - é‡è¯•æŒ‰é’®
```

## ğŸ”„ è‡ªåŠ¨åŒ–å·¥ä½œæµ

### 1. æ–°è®°å¿†è‡ªåŠ¨å‘é‡åŒ–

```typescript
// å½“æ–°è®°å¿†æ·»åŠ æ—¶
addMemory() {
  // 1. ä¿å­˜åˆ°è®°å¿†ç³»ç»Ÿ
  // 2. å¦‚æœå¯ç”¨è‡ªåŠ¨å‘é‡åŒ–
  if (vectorConfig.autoVectorize) {
    // 3. åŠ å…¥å‘é‡åŒ–é˜Ÿåˆ—
    vectorService.enqueue({
      id: memory.id,
      text: memory.content,
      category: memory.category
    });
  }
}
```

### 2. æ€»ç»“æ—¶æ‰¹é‡å‘é‡åŒ–

```typescript
// ç”Ÿæˆæ€»ç»“å
generateSummary() {
  // 1. ç”Ÿæˆæ€»ç»“
  const summary = await aiService.summarize(...);
  
  // 2. å¦‚æœå¯ç”¨æ€»ç»“å‘é‡åŒ–
  if (vectorConfig.vectorizeOnSummary) {
    // 3. å‘é‡åŒ–æ€»ç»“å’Œç›¸å…³è®°å¿†
    await vectorService.batchVectorize([
      summary,
      ...sourceMemories
    ]);
  }
}
```

### 3. åå°æ‰¹é‡å¤„ç†

```typescript
// æ‰¹é‡å‘é‡åŒ–æœªå¤„ç†çš„è®°å¿†
async processVectorQueue() {
  const pending = await getPendingMemories();
  const batches = chunk(pending, vectorConfig.batchSize);
  
  for (const batch of batches) {
    try {
      await vectorService.batchVectorize(batch);
    } catch (error) {
      // è®°å½•é”™è¯¯ï¼Œç¨åé‡è¯•
      logFailedBatch(batch, error);
    }
  }
}
```

## ğŸš€ å®ç°ä¼˜å…ˆçº§

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ (MVP)
1. âœ… å‘é‡åŒ–APIé›†æˆ
2. âœ… åŸºç¡€å‘é‡å­˜å‚¨
3. âœ… ç®€å•è¯­ä¹‰æœç´¢
4. âœ… é…ç½®ç•Œé¢

### Phase 2: è‡ªåŠ¨åŒ–
5. è‡ªåŠ¨å‘é‡åŒ–æ–°è®°å¿†
6. æ‰¹é‡å¤„ç†é˜Ÿåˆ—
7. é”™è¯¯å¤„ç†å’Œé‡è¯•

### Phase 3: é«˜çº§åŠŸèƒ½
8. æ··åˆæœç´¢ï¼ˆå‘é‡+å…³é”®è¯ï¼‰
9. å‘é‡ç´¢å¼•ä¼˜åŒ–
10. èšç±»å’Œä¸»é¢˜åˆ†æ
11. æ™ºèƒ½æ¨è

## ğŸ’¡ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1ï¼šæŸ¥æ‰¾ç›¸ä¼¼ç»å†
```
ç”¨æˆ·æœç´¢ï¼š"å’Œç¥ç§˜å¥³å­çš„å¯¹è¯"
ç³»ç»Ÿè¿”å›ï¼š
  1. [æ¢ç´¢] ä¸ç™½è¡£å¥³å­çš„é‚‚é€… (ç›¸ä¼¼åº¦: 0.92)
  2. [åŒ»é¦†] è¯Šæ²»å¥³æ‚£è€…çš„ç»å† (ç›¸ä¼¼åº¦: 0.87)
  3. [å£°æœ›] æ•‘åŠ©å°‘å¥³çš„ä¼ é—» (ç›¸ä¼¼åº¦: 0.81)
```

### åœºæ™¯2ï¼šä¸»é¢˜è¿½è¸ª
```
ç”¨æˆ·æœç´¢ï¼š"ä¿®ç‚¼çªç ´"
ç³»ç»Ÿè¿”å›æ‰€æœ‰ä¸ä¿®ç‚¼çªç ´ç›¸å…³çš„è®°å¿†ï¼ŒæŒ‰ç›¸ä¼¼åº¦æ’åº
```

### åœºæ™¯3ï¼šè§’è‰²å…³ç³»ç½‘ç»œ
```
åŸºäºå‘é‡ç›¸ä¼¼åº¦ï¼Œæ„å»ºè§’è‰²ä¹‹é—´çš„å…³ç³»å›¾è°±
```

## ğŸ“ APIæ¥å£è®¾è®¡

### æ¨èçš„Embedding API

```typescript
// 1. OpenAIå…¼å®¹æ¥å£
POST https://api.openai.com/v1/embeddings
{
  "model": "text-embedding-3-small",
  "input": "è¦å‘é‡åŒ–çš„æ–‡æœ¬",
  "encoding_format": "float"
}

// 2. æœ¬åœ°éƒ¨ç½²æ–¹æ¡ˆ
// - Ollama + nomic-embed-text
// - FastEmbed
// - Sentence Transformers
```

### é…ç½®ç¤ºä¾‹

```typescript
const defaultConfig: VectorConfig = {
  enabled: true,
  apiUrl: 'https://api.openai.com/v1',
  apiKey: 'your-api-key',
  model: 'text-embedding-3-small',
  autoVectorize: true,
  vectorizeOnSummary: true,
  batchSize: 10,
  similarityThreshold: 0.7,
  maxResults: 20,
  hybridSearch: false,
  retryAttempts: 3,
  cacheEnabled: true
};
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **APIæˆæœ¬**ï¼šå‘é‡åŒ–éœ€è¦è°ƒç”¨APIï¼Œæ³¨æ„æ§åˆ¶æˆæœ¬
2. **å­˜å‚¨ç©ºé—´**ï¼šå‘é‡æ•°æ®è¾ƒå¤§ï¼ˆæ¯æ¡1536ç»´ â‰ˆ 6KBï¼‰ï¼Œéœ€è¦ç›‘æ§å­˜å‚¨
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤§é‡å‘é‡æœç´¢å¯èƒ½è¾ƒæ…¢ï¼Œéœ€è¦ç´¢å¼•ä¼˜åŒ–
4. **éšç§å®‰å…¨**ï¼šAPI Keyéœ€è¦åŠ å¯†å­˜å‚¨
5. **ç¦»çº¿æ”¯æŒ**ï¼šè€ƒè™‘æœ¬åœ°å‘é‡åŒ–æ–¹æ¡ˆ

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

- âœ… æœç´¢å‡†ç¡®ç‡ > 85%
- âœ… å“åº”æ—¶é—´ < 2ç§’
- âœ… å‘é‡åŒ–æˆåŠŸç‡ > 95%
- âœ… ç”¨æˆ·æ»¡æ„åº¦æå‡

---

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-15  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ